trigger:
  batch: true
  branches:
    include:
      - develop
  paths:
    exclude:
      - test/*
      - bin/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: replicas
    value: '1'
  - name: maxSurge
    value: '0'
  - name: maxUnavailable
    value: '1'
  - name: storage
    value: '2Gi'
  - name: domainIngress
    value: 'dev-logistics.recordgo.cloud'
  - name: KubernetesNamespace
    value: 'prj028-dev-logistics'
  - group: 'Azure Configuration'

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: Build
        displayName: Build Docker
        steps:
          - checkout: self
            submodules: true
            persistCredentials: true

          - task: Docker@2
            displayName: 'Build $(KubernetesNamespace) image'
            inputs:
              containerRegistry: $(DockerRegistryServiceConnection)
              repository: '$(KubernetesNamespace)-app'
              command: 'build'
              tags: $(Build.BuildId)
              Dockerfile: 'deploy/docker/Dockerfile-DEV'
              buildContext: '$(Build.SourcesDirectory)'
            condition: succeeded()
            env:
              DOCKER_BUILDKIT: 1

          - task: Docker@2
            displayName: 'Push $(KubernetesNamespace) image'
            inputs:
              containerRegistry: $(DockerRegistryServiceConnection)
              repository: '$(KubernetesNamespace)-app'
              command: 'push'
              tags: $(Build.BuildId)
            condition: succeeded()

  - stage: Deploy
    displayName: Deploy
    dependsOn: Build
    jobs:
      - job: Deploy
        displayName: Deploy in AKS
        steps:
          - task: replacetokens@5
            displayName: Replace Tokens
            inputs:
              rootDirectory: '$(Build.SourcesDirectory)/deploy/aks'
              targetFiles: '**/*.yaml'
              encoding: 'auto'
              tokenPattern: 'rm'
              writeBOM: true
              actionOnMissing: 'warn'
              keepToken: false
              actionOnNoFiles: 'continue'
              enableTransforms: false
              enableRecursion: false
              useLegacyPattern: false
              enableTelemetry: true

            # Descargar el archivo kubeconfig seguro
          - task: DownloadSecureFile@1
            name: DownloadKubeconfig
            inputs:
              secureFile: kubeconfig-recordgo.yaml

          - script: |
              export KUBECONFIG=$(DownloadKubeconfig.secureFilePath)
              echo "Configuration, service and deployment"
              kubectl apply -f $(Build.SourcesDirectory)/deploy/aks/namespace.yaml -f $(Build.SourcesDirectory)/deploy/aks/configuration.yaml -f $(Build.SourcesDirectory)/deploy/aks/volume.yaml -f $(Build.SourcesDirectory)/deploy/aks/service.yaml -f $(Build.SourcesDirectory)/deploy/aks/deployment.yaml
            displayName: 'Configuration, service and deployment'

            # Aplicar todos los manifiestos
          - script: |
              export KUBECONFIG=$(DownloadKubeconfig.secureFilePath)
              echo "Aplicando manifiestos..."
              kubectl apply -f $(Build.SourcesDirectory)/deploy/aks/
            displayName: 'Aplicar manifiestos al clÃºster'

          - script: |
              export KUBECONFIG=$(DownloadKubeconfig.secureFilePath)
              echo "Ingress...."
              kubectl apply -f $(Build.SourcesDirectory)/deploy/aks/ingress.yaml
            displayName: 'Ingress'

            # Reaplicar TLS secret
          - script: |
              export KUBECONFIG=$(DownloadKubeconfig.secureFilePath)
              echo "Reaplicando tls-secret-csi..."
              kubectl get secret tls-secret-csi --namespace=ingress-nginx -o yaml \
                | sed '/creationTimestamp/d' \
                | sed '/namespace/d' \
                | sed '/resourceVersion/d' \
                | sed '/labels/d' \
                | sed '/secrets-store.csi.k8s.io/d' \
                | sed '/ownerReferences/d' \
                | sed '/- apiVersion/d' \
                | sed '/kind: SecretProviderClassPodStatus/{N;d;}' \
                | sed '/kind: ReplicaSet/{N;d;}' \
                | sed '/uid/d' > $(Build.SourcesDirectory)/deploy/aks/tls-secret-csi.yaml
              
              kubectl apply -f $(Build.SourcesDirectory)/deploy/aks/tls-secret-csi.yaml -n $(KubernetesNamespace)
            displayName: 'Reaplicar TLS secret'